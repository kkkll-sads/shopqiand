# 字段映射文档

## 概述

本文档描述前端与后端之间的字段映射关系、数据类型转换规则和使用方法。

---

## 一、字段映射关系

### 1.1 用户信息字段映射

| 后端字段 | 前端字段 | 类型 | 说明 | 转换规则 |
|---------|---------|------|------|---------|
| `id` | `id` | number | 用户ID | 无需转换 |
| `username` | `username` | string | 用户名 | 无需转换 |
| `nickname` | `nickname` | string | 昵称 | 无需转换 |
| `mobile` | `mobile` | string | 手机号 | 无需转换 |
| `avatar` | `avatar` | string | 头像URL | 无需转换 |
| `money` | `totalAssets` | number | 总资产 | string→number |
| `balance_available` | `availableBalance` | number | 可用余额 | string→number |
| `service_fee_balance` | `serviceFeeBalance` | number | 确权金 | string→number |
| `withdrawable_money` | `withdrawableBalance` | number | 可提现余额 | string→number |
| `score` | `consumptionPoints` | number | 消费金 | number保持 |
| `green_power` | `greenPower` | number | 绿色算力 | string→number |
| `pending_activation_gold` | `pendingActivationGold` | number | 待激活金 | string→number |
| `last_login_time` | `lastLoginTime` | Date | 最后登录时间 | timestamp→Date |
| `join_time` | `joinTime` | Date | 注册时间 | timestamp→Date |
| `token` | `token` | string | 登录令牌 | 无需转换 |
| `invite_code` | `inviteCode` | string | 邀请码 | 无需转换 |
| `agent_review_status` | `agentReviewStatus` | number | 代理审核状态 | 无需转换 |
| `real_name` | `realName` | string | 实名姓名 | 无需转换 |
| `real_name_status` | `realNameStatus` | number | 实名状态 | 无需转换 |
| `consignment_coupon` | `consignmentCoupon` | number | 寄售券数量 | 无需转换 |

### 1.2 藏品信息字段映射

| 后端字段 | 前端字段 | 类型 | 说明 | 转换规则 |
|---------|---------|------|------|---------|
| `id` | `id` | number | 藏品ID | 无需转换 |
| `title` | `title` | string | 藏品标题 | 无需转换 |
| `price` | `price` | number | 价格 | string→number |
| `image` | `image` | string | 图片URL | 无需转换 |
| `session_id` | `sessionId` | number | 场次ID | 无需转换 |
| `zone_id` | `zoneId` | number | 价格分区ID | 无需转换 |
| `asset_code` | `assetCode` | string | 确权编号 | 无需转换 |
| `tx_hash` | `txHash` | string | 存证指纹 | 无需转换 |
| `owner_id` | `ownerId` | number | 持有人ID | 无需转换 |
| `supplier_name` | `supplierName` | string | 供应商名称 | 无需转换 |
| `consignment_id` | `consignmentId` | number | 寄售ID | 无需转换 |
| `consignment_price` | `consignmentPrice` | number | 寄售价格 | string→number |
| `stock` | `stock` | number | 库存 | 无需转换 |
| `sales` | `sales` | number | 销量 | 无需转换 |
| `package_id` | `packageId` | number | 资产包ID | 无需转换 |
| `package_name` | `packageName` | string | 资产包名称 | 无需转换 |

### 1.3 寄售券字段映射

| 后端字段 | 前端字段 | 类型 | 说明 | 转换规则 |
|---------|---------|------|------|---------|
| `id` | `id` | number | 寄售券ID | 无需转换 |
| `user_id` | `userId` | number | 用户ID | 无需转换 |
| `session_id` | `sessionId` | number | 场次ID | 无需转换 |
| `zone_id` | `zoneId` | number | 价格区间ID | 无需转换 |
| `price_zone` | `priceZone` | string | 价格区间名称 | 无需转换 |
| `expire_time` | `expireTime` | Date | 过期时间 | timestamp→Date |
| `status` | `status` | number | 状态 | 无需转换 |
| `status` | `isAvailable` | boolean | 是否可用 | 1→true, 0→false |
| `create_time` | `createTime` | Date | 创建时间 | timestamp→Date |
| `update_time` | `updateTime` | Date | 更新时间 | timestamp→Date |

### 1.4 订单信息字段映射

| 后端字段 | 前端字段 | 类型 | 说明 | 转换规则 |
|---------|---------|------|------|---------|
| `id` | `id` | number | 订单ID | 无需转换 |
| `order_no` | `orderNo` | string | 订单号 | 无需转换 |
| `product_name` | `productName` | string | 商品名称 | 无需转换 |
| `product_image` | `productImage` | string | 商品图片 | 无需转换 |
| `price` | `price` | number | 单价 | string→number |
| `quantity` | `quantity` | number | 数量 | 无需转换 |
| `total_amount` | `totalAmount` | number | 总金额 | string→number |
| `status` | `status` | string | 订单状态 | 无需转换 |
| `pay_time` | `payTime` | Date | 支付时间 | timestamp→Date |
| `create_time` | `createTime` | Date | 创建时间 | timestamp→Date |
| `update_time` | `updateTime` | Date | 更新时间 | timestamp→Date |

---

## 二、数据类型转换规则

### 2.1 时间戳转换

**后端格式**: Unix时间戳（秒级）  
**前端格式**: JavaScript Date对象

```typescript
// 转换函数
function convertTimestamp(timestamp: number | string): Date {
  const ts = typeof timestamp === 'string' ? parseInt(timestamp, 10) : timestamp;
  return new Date(ts * 1000); // 秒转毫秒
}

// 使用示例
const createTime = convertTimestamp(data.create_time);
```

### 2.2 金额字符串转换

**后端格式**: string (例如: "100.00")  
**前端格式**: number

```typescript
// 转换函数
function convertAmount(amount: string | number): number {
  if (typeof amount === 'number') return amount;
  return parseFloat(amount) || 0;
}

// 使用示例
const price = convertAmount(data.price);
```

### 2.3 状态值转布尔值

**后端格式**: number (1 或 0)  
**前端格式**: boolean

```typescript
// 转换函数
function convertStatus(status: number): boolean {
  return status === 1;
}

// 使用示例
const isAvailable = convertStatus(data.status);
```

### 2.4 数组字符串转换

**后端格式**: string (JSON字符串或逗号分隔)  
**前端格式**: Array

```typescript
// 转换函数
function convertArrayString(str: string): string[] {
  if (Array.isArray(str)) return str;
  try {
    return JSON.parse(str);
  } catch {
    return str.split(',').filter(Boolean);
  }
}

// 使用示例
const images = convertArrayString(data.images);
```

---

## 三、使用方法

### 3.1 自动字段映射

```typescript
import { mapFields, USER_FIELD_MAPPING } from '@/utils/fieldMapping';

// 后端返回的用户数据
const backendUser = {
  id: 1,
  username: 'test',
  balance_available: '1000.00',
  service_fee_balance: '500.00',
};

// 自动映射字段
const frontendUser = mapFields(backendUser, USER_FIELD_MAPPING);
// 结果: { id: 1, username: 'test', availableBalance: '1000.00', serviceFeeBalance: '500.00' }
```

### 3.2 批量数组映射

```typescript
import { mapFieldsArray, COLLECTION_FIELD_MAPPING } from '@/utils/fieldMapping';

// 后端返回的藏品列表
const backendList = [
  { id: 1, title: '藏品1', price: '100.00' },
  { id: 2, title: '藏品2', price: '200.00' },
];

// 批量映射
const frontendList = mapFieldsArray(backendList, COLLECTION_FIELD_MAPPING);
```

### 3.3 特定类型转换

```typescript
import { convertUserFields, convertCollectionFields } from '@/utils/fieldMapping';

// 用户数据转换（包含字段映射 + 类型转换）
const user = convertUserFields(backendUserData);

// 藏品数据转换
const collection = convertCollectionFields(backendCollectionData);
```

### 3.4 反向映射（前端→后端）

```typescript
import { reverseMapFields, USER_FIELD_MAPPING } from '@/utils/fieldMapping';

// 前端数据
const frontendData = {
  availableBalance: 1000,
  serviceFeeBalance: 500,
};

// 反向映射为后端字段
const backendData = reverseMapFields(frontendData, USER_FIELD_MAPPING);
// 结果: { balance_available: 1000, service_fee_balance: 500 }
```

### 3.5 字段验证

```typescript
import { validateRequiredFields, USER_REQUIRED_FIELDS } from '@/utils/fieldMapping';

// 验证必填字段
const result = validateRequiredFields(userData, USER_REQUIRED_FIELDS);

if (!result.valid) {
  console.error('缺少必填字段:', result.missing);
}
```

---

## 四、字段别名支持

某些后端接口可能使用不同的字段名返回相同的数据：

| 标准字段 | 可能的别名 |
|---------|-----------|
| `userId` | `user_id`, `uid`, `userid` |
| `createTime` | `create_time`, `createtime`, `created_at`, `createdAt` |
| `updateTime` | `update_time`, `updatetime`, `updated_at`, `updatedAt` |
| `price` | `price`, `amount`, `money` |
| `image` | `image`, `img`, `pic`, `picture`, `photo` |

---

## 五、最佳实践

### 5.1 在API响应拦截器中统一转换

```typescript
// services/client.ts
import { convertUserFields } from '@/utils/fieldMapping';

async function fetchUserProfile() {
  const response = await fetch('/api/Account/profile');
  const data = await response.json();
  
  // 在拦截器中统一转换字段
  return convertUserFields(data.data);
}
```

### 5.2 定义清晰的前端接口类型

```typescript
// types/user.ts
export interface FrontendUserInfo {
  id: number;
  username: string;
  availableBalance: number;  // 使用前端字段名
  serviceFeeBalance: number;
  // ...
}
```

### 5.3 避免在组件中手动转换

```typescript
// ❌ 不推荐：在组件中手动转换
function UserProfile() {
  const [user, setUser] = useState(null);
  
  useEffect(() => {
    fetchUser().then(data => {
      // 手动转换字段名
      setUser({
        availableBalance: data.balance_available,
        serviceFeeBalance: data.service_fee_balance,
      });
    });
  }, []);
}

// ✅ 推荐：使用工具函数自动转换
function UserProfile() {
  const [user, setUser] = useState(null);
  
  useEffect(() => {
    fetchUser().then(data => {
      setUser(convertUserFields(data));
    });
  }, []);
}
```

---

## 六、注意事项

### 6.1 时间戳单位

⚠️ **重要**: 后端返回的时间戳是**秒级**，前端需要转换为**毫秒级**

```typescript
// 正确
const date = new Date(timestamp * 1000);

// 错误
const date = new Date(timestamp); // 会导致日期错误
```

### 6.2 金额精度

⚠️ 金额计算时注意浮点数精度问题：

```typescript
// 推荐使用库处理金额
import Big from 'big.js';

const result = new Big(price1).plus(price2).toNumber();
```

### 6.3 字段缺失处理

```typescript
// 提供默认值
const availableBalance = convertAmount(data.balance_available) || 0;

// 使用可选链
const userName = data?.user_info?.nickname ?? '未设置';
```

### 6.4 类型安全

```typescript
// 使用TypeScript泛型确保类型安全
function mapFields<T extends Record<string, any>>(
  data: T,
  mapping: Record<string, string>
): Record<string, any> {
  // ...
}
```

---

## 七、常见问题

### Q1: 为什么需要字段映射？

**A**: 
1. 前后端命名规范不同（后端使用下划线，前端使用驼峰）
2. 提高代码可读性和维护性
3. 统一数据转换逻辑，避免重复代码

### Q2: 如何处理嵌套对象的字段映射？

**A**: 递归映射或针对特定结构写专用转换函数：

```typescript
function convertNestedObject(data: any) {
  return {
    ...mapFields(data, BASIC_MAPPING),
    userInfo: convertUserFields(data.user_info),
    orderList: mapFieldsArray(data.order_list, ORDER_FIELD_MAPPING),
  };
}
```

### Q3: 字段映射会影响性能吗？

**A**: 影响很小。对于大列表建议：
1. 使用虚拟滚动减少渲染数量
2. 在数据获取层一次性转换，避免在渲染中重复转换
3. 使用 `useMemo` 缓存转换结果

---

## 八、更新日志

### 2026-01-06
- 初始版本
- 添加用户、藏品、寄售券、订单字段映射
- 添加常用类型转换函数
- 添加字段验证功能

---

**文档维护**: 前端开发团队  
**最后更新**: 2026-01-06
