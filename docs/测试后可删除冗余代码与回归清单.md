# 测试后可删除冗余代码与回归清单

> 版本: v1.0  
> 更新时间: 2026-02-10  
> 适用分支: `0114`

## 目标

- 在保留当前已上线功能的前提下，分批清理历史兼容代码与冗余分支。
- 每一项“可删除”都绑定明确的前置验证条件，避免误删导致线上回归。

## 执行规则

1. 每次删除前，先通过自动校验:
   - `npm run typecheck`
   - `npm run test`
   - `npm run build`
2. 每次删除后，必须完整执行本文 P0 回归清单。
3. 删除“协议兼容/老设备兼容”代码时，必须先确认后端协议已统一，且低端机真机回归已通过。

## 一、测试后可删除冗余代码候选

| 编号 | 文件位置 | 冗余/兼容点 | 删除前置条件 | 必测页面/功能 | 风险 |
| --- | --- | --- | --- | --- | --- |
| R-001 | `/Users/a0000/shopqiand/src/services/client.ts:24` | `getToken` 兼容别名（已标注 deprecated） | 全仓检索无 `getToken` 外部引用，仅保留 `getStoredToken` | 登录态读取、客服用户信息注入、所有鉴权请求 | 低 |
| R-002 | `/Users/a0000/shopqiand/src/services/auth.ts:125` | `retrievePassword` 同时传 `password` + `newpassword` | 后端确认仅 `password` 即可，联调通过 | 找回密码全流程（发送验证码、重置成功、可登录） | 中 |
| R-003 | `/Users/a0000/shopqiand/src/services/common.ts:78` | 上传响应兼容字段 `path/filepath/fullurl/fullUrl` 与旧格式分支 | 上传接口返回结构统一为 `url/full_url` | 头像上传、代理认证材料上传、图片回显 | 中 |
| R-004 | `/Users/a0000/shopqiand/src/constants/balanceTypes.ts:12` | `money` 字段兼容映射（deprecated） | 资金接口与页面全部切到新字段，`money` 无业务依赖 | 资产总览、充值支付方式、收支流水展示 | 中 |
| R-005 | `/Users/a0000/shopqiand/src/types/index.ts:105` | `static_income/dynamic_income/confirm_rights_gold/legacy_frozen` 等旧字段 | 页面和 hooks 全部改为新字段，后端不再返回旧字段 | 拓展收益提现、确权金解锁、资产页卡片金额 | 高 |
| R-006 | `/Users/a0000/shopqiand/src/constants/statusEnums.ts:37` | 状态枚举旧别名（如 `NOT_CONSIGNED/CONSIGNING/APPROVED/REFUNDED`） | 业务代码全部替换为新语义枚举值 | 我的藏品寄售状态、申购记录状态筛选、消息中心状态文案 | 高 |
| R-007 | `/Users/a0000/shopqiand/src/pages/market/ReservationPage.tsx:44` | `fallbackProduct` 与部分预加载兜底分支 | 入口统一保证传入完整商品/场次/分区/资产包 | 证书页跳转预约、直达预约链接、提交预约与返回 | 中 |
| R-008 | `/Users/a0000/shopqiand/src/services/config.ts:78` | 旧 IP 地址 URL 转相对路径兼容逻辑 | 后端仅返回域名 URL，Nginx 代理策略稳定 | 富文本图片、上传回显、跨域/混合内容检查 | 中 |
| R-009 | `/Users/a0000/shopqiand/src/components/common/ChatWidget.tsx:21` | 客服主备地址硬编码常量 | 客服配置后端化完成并默认从接口下发 | 客服按钮打开、脚本失败回退、备用链接打开 | 中 |
| R-010 | `/Users/a0000/shopqiand/src/utils/errorHelpers.ts:121` | `extractErrorMessage` 旧错误提取链（deprecated） | `useErrorHandler` 迁移到 `apiHelpers` 后无旧函数引用 | 订单详情、评价提交、提现/绑卡错误提示准确性 | 中-高 |

## 二、当前明确“先保留，不允许删除”的兼容代码

| 文件位置 | 保留原因 | 复核条件 |
| --- | --- | --- |
| `/Users/a0000/shopqiand/src/utils/backdropCompat.ts:27` | 针对老 Android/WebView 的模糊渲染兼容；当前仍有机型颜色异常反馈 | 至少覆盖 Android 9/10 低内存机型真机回归通过 |
| `/Users/a0000/shopqiand/src/styles/main.css:365` | 个人中心颜色兜底样式，直接关联“部分机型颜色显示异常”问题 | 低端机与主流机型颜色一致后再评估 |

## 三、删除前必须执行的页面/功能回归清单

## P0（必须全通过）

| 路由/入口 | 必测功能 | 通过标准 |
| --- | --- | --- |
| `/real-name-auth` | 实名认证提交 -> 第三方扫脸 -> 回跳处理 | 回到认证页后能正确进入“已实名/审核中”，不出现刷新后卡住未完成 |
| 首页客服入口（浮窗按钮） | widget 加载、主链接与备用链接兜底 | 主链可打开；主链失败时备用链可打开且不报错 |
| `/profile` | 个人中心卡片颜色/文字可读性 | 老机型与常规机型颜色正常、文字对比度可读 |
| `/balance-recharge` | 支付跳转组件 `PaymentRedirect` 各状态 | 准备中/支付中/校验中/失败重试分支均正常 |
| `/balance-withdraw` | 收益提现主流程 | 加载银行卡、金额校验、密码弹窗、提交结果反馈正确 |
| `/card-management` | 银行卡管理增删改 | 列表、新增、删除、选择状态稳定 |
| `/extension-withdraw` | 拓展收益提现 | 可提现金额、手续费、提交及错误提示正确 |
| `/my-collection` + `/my-collection/:id` | 藏品列表与详情操作 | 列表加载、详情打开、底部操作按钮行为正确 |
| `/product/:id`（藏品） | 证书页加载与“申请确权” | 证书信息正确，跳转预约链路完整 |
| `/reservation` | 预约参数与提交 | 场次/分区/价格计算正确，提交成功并可返回 |
| `/reservation-record` | 申购记录筛选与状态文案 | 筛选、排序、状态映射与详情跳转正确 |
| `/order/:orderId` + `/collection-order/:id` | 订单详情状态流转 | 状态展示、操作按钮、错误提示一致 |
| `/submit-review` | 评价提交 | 文本/图片提交、失败提示与返回刷新正常 |
| `/login` | 登录与登录后跳转 | 登录成功、失败提示、token 写入与后续页面鉴权正常 |

## P1（建议同批回归）

| 路由/入口 | 必测功能 | 通过标准 |
| --- | --- | --- |
| `/`（首页） | 快捷入口、公告、首屏数据加载 | 首屏渲染稳定，无白屏和异常闪烁 |
| `/market` | 列表筛选、分页、商品跳转 | 分类/排序有效，详情跳转参数完整 |
| `/cumulative-rights` | 权益总览（余额/收益/藏品统计） | 三块数据卡片展示正确，订单资金详情入口可跳转 |
| `/user-survey` | 调查问卷三模块（填写/提交/历史） | 提交流程、历史记录切换、状态提示正确 |
| `/address-list` | 地址列表操作 | 列表刷新、新增/编辑/删除反馈正常 |
| `/sign-in` | 签到状态与记录展示 | 当天状态、历史数据和奖励展示一致 |

## 四、建议删除顺序（按风险从低到高）

1. 低风险快速清理: `R-001`
2. 协议确认后清理: `R-002`, `R-003`, `R-008`, `R-009`
3. 资金/状态模型迁移后清理: `R-004`, `R-005`, `R-006`
4. 错误体系重构后清理: `R-010`
5. `backdrop` 与颜色兜底不进入本轮删除范围（先稳态，后评估）

## 五、备注

- 本清单用于“删除决策门禁”，不是立即删除指令。
- 只要任一 P0 回归失败，即停止删除动作并回滚该批次变更。
